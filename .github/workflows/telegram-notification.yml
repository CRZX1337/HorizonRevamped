name: Telegram Notification

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit-info
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "event_type=Push" >> $GITHUB_OUTPUT
            echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
            echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
            echo "sha=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
          else
            echo "event_type=Release" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
            echo "author=${{ github.event.release.author.login }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸ”” *New ${{ steps.commit-info.outputs.event_type }} to HorizonRevamped*
            
            *Commit:* `${{ steps.commit-info.outputs.sha }}`
            *Author:* ${{ steps.commit-info.outputs.author }}
            *Message:* ${{ steps.commit-info.outputs.message }}
            
            [View on GitHub](https://github.com/CRZX1337/HorizonRevamped/commit/${{ github.sha }})
          format: markdown
          message_thread_id: ${{ secrets.TELEGRAM_CLI_TOPIC_THREAD_ID }}