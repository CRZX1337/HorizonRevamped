name: Telegram Notification

on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  telegram_notification:
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram Message to CLI Topic (using curl)
        shell: bash
        env: # Make secrets easily available as environment variables in the script
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CLI_TOPIC_THREAD_ID: ${{ secrets.TELEGRAM_CLI_TOPIC_THREAD_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GITHUB_COMMIT_URL: ${{ github.event.head_commit.url }}
          GITHUB_RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          GITHUB_RELEASE_AUTHOR_LOGIN: ${{ github.event.release.author.login }}
          GITHUB_RELEASE_BODY: ${{ github.event.release.body }}
          GITHUB_RELEASE_HTML_URL: ${{ github.event.release.html_url }}
        run: |
          MESSAGE_TEXT=""

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            MESSAGE_TEXT="ðŸ“¢ *New activity on ${GITHUB_REPOSITORY}* ðŸ“¢\n\n" \
                         "*Event:* ${GITHUB_EVENT_NAME}\n" \
                         "*Commit by:* ${GITHUB_ACTOR} pushed to ${GITHUB_REF_NAME}\n" \
                         "*Message:* ${GITHUB_COMMIT_MESSAGE}\n\n" \
                         "*Repository:* [${GITHUB_REPOSITORY}](https://github.com/${GITHUB_REPOSITORY})\n" \
                         "*Commit Link:* [${GITHUB_COMMIT_MESSAGE:0:50}...](https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})" # Shorten commit message in link text

          elif [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            MESSAGE_TEXT="ðŸŽ‰ *New Release on ${GITHUB_REPOSITORY}* ðŸŽ‰\n\n" \
                         "*Event:* ${GITHUB_EVENT_NAME}\n" \
                         "*Release:* *${GITHUB_RELEASE_TAG_NAME}* by ${GITHUB_RELEASE_AUTHOR_LOGIN}\n\n" \
                         "*Repository:* [${GITHUB_REPOSITORY}](https://github.com/${GITHUB_REPOSITORY})\n" \
                         "*Release Link:* [${GITHUB_RELEASE_TAG_NAME}](https://github.com/${GITHUB_REPOSITORY}/releases/tag/${GITHUB_RELEASE_TAG_NAME})\n\n" \
                         "*Release Notes:*\n${GITHUB_RELEASE_BODY}"
          else
            MESSAGE_TEXT="ðŸ“¢ *New activity on ${GITHUB_REPOSITORY}* ðŸ“¢\n\n" \
                         "*Event:* ${GITHUB_EVENT_NAME}\n\n" \
                         "Something happened on the repository."
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "message_thread_id=${TELEGRAM_CLI_TOPIC_THREAD_ID}" \
            -d "text=${MESSAGE_TEXT}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"